import promise for Promise, resolved, rejected

fun async(fn)
    return fun(...args)
        var gen = fn(...args)
        return Promise(fun(resolve, reject)
            fun step(arg, exc)
                var value
                try
                    value = gen(arg) if !exc else gen.throw(exc)
                except Exception e
                    reject(e)
                    return
                end

                if gen.isDone()
                    resolve(value)
                else
                    return resolved(value).then(fun(value)
                        step(value, null)
                    end, fun(exc)
                        step(null, exc)
                    end)
                end
            end
            step(null, null)
        end)
    end
end
